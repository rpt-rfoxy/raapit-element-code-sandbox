{"version":3,"file":"preeval.js","names":["createCustomDebug","EventEmitter","getFileIdx","addIdentifierToLinariaPreval","removeDangerousCode","isFeatureEnabled","processTemplateExpression","onFinishCallbacks","WeakMap","preeval","babel","eventEmitter","dummy","options","types","t","name","pre","file","filename","opts","log","rootScope","scope","processors","onProcessTemplateFinished","pair","method","path","traverse","Identifier","p","processor","dependencies","forEach","dependency","ex","type","doEvaltimeReplacement","push","features","onCodeRemovingFinished","set","visitor","post","get","length","metadata","linaria","replacements","rules","linariaPreval","getData","linariaExport","expressionStatement","assignmentExpression","memberExpression","identifier","objectExpression","pushContainer"],"sources":["../../src/plugins/preeval.ts"],"sourcesContent":["/**\n * This file is a babel preset used to transform files inside evaluators.\n * It works the same as main `babel/extract` preset, but do not evaluate lazy dependencies.\n */\nimport type { BabelFile, PluginObj } from '@babel/core';\n\nimport { createCustomDebug } from '@linaria/logger';\nimport type { StrictOptions } from '@linaria/utils';\nimport {\n  EventEmitter,\n  getFileIdx,\n  addIdentifierToLinariaPreval,\n  removeDangerousCode,\n  isFeatureEnabled,\n} from '@linaria/utils';\n\nimport type { Core } from '../babel';\nimport type { IPluginState } from '../types';\nimport { processTemplateExpression } from '../utils/processTemplateExpression';\n\nexport type PreevalOptions = Pick<\n  StrictOptions,\n  'classNameSlug' | 'displayName' | 'evaluate' | 'features'\n> & { eventEmitter: EventEmitter };\n\nconst onFinishCallbacks = new WeakMap<object, () => void>();\n\nexport default function preeval(\n  babel: Core,\n  { eventEmitter = EventEmitter.dummy, ...options }: PreevalOptions\n): PluginObj<IPluginState & { onFinish: () => void }> {\n  const { types: t } = babel;\n  return {\n    name: '@linaria/babel/preeval',\n    pre(file: BabelFile) {\n      const filename = file.opts.filename!;\n      const log = createCustomDebug('preeval', getFileIdx(filename));\n\n      log('start', 'Looking for template literalsâ€¦');\n\n      const rootScope = file.scope;\n      this.processors = [];\n\n      const onProcessTemplateFinished = eventEmitter.pair({\n        method: 'preeval:processTemplate',\n      });\n\n      file.path.traverse({\n        Identifier: (p) => {\n          processTemplateExpression(p, file.opts, options, (processor) => {\n            processor.dependencies.forEach((dependency) => {\n              if (dependency.ex.type === 'Identifier') {\n                addIdentifierToLinariaPreval(rootScope, dependency.ex.name);\n              }\n            });\n\n            processor.doEvaltimeReplacement();\n            this.processors.push(processor);\n          });\n        },\n      });\n\n      onProcessTemplateFinished();\n\n      if (\n        isFeatureEnabled(options.features, 'dangerousCodeRemover', filename)\n      ) {\n        log('start', 'Strip all JSX and browser related stuff');\n        const onCodeRemovingFinished = eventEmitter.pair({\n          method: 'preeval:removeDangerousCode',\n        });\n        removeDangerousCode(file.path);\n        onCodeRemovingFinished();\n      }\n\n      onFinishCallbacks.set(\n        this,\n        eventEmitter.pair({ method: 'preeval:rest-transformations' })\n      );\n    },\n    visitor: {},\n    post(file: BabelFile) {\n      onFinishCallbacks.get(this)?.();\n\n      const log = createCustomDebug('preeval', getFileIdx(file.opts.filename!));\n\n      if (this.processors.length === 0) {\n        log('end', \"We didn't find any Linaria template literals\");\n\n        // We didn't find any Linaria template literals.\n        return;\n      }\n\n      this.file.metadata.linaria = {\n        processors: this.processors,\n        replacements: [],\n        rules: {},\n        dependencies: [],\n      };\n\n      const linariaPreval = file.path.getData('__linariaPreval');\n      if (!linariaPreval) {\n        // Event if there is no dependencies, we still need to add __linariaPreval\n        const linariaExport = t.expressionStatement(\n          t.assignmentExpression(\n            '=',\n            t.memberExpression(\n              t.identifier('exports'),\n              t.identifier('__linariaPreval')\n            ),\n            t.objectExpression([])\n          )\n        );\n\n        file.path.pushContainer('body', linariaExport);\n      }\n\n      log('end', '__linariaPreval has been added');\n    },\n  };\n}\n"],"mappings":"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"}