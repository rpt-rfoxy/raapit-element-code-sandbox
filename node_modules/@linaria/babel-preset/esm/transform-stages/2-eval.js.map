{"version":3,"file":"2-eval.js","names":["createCustomDebug","getFileIdx","evaluate","hasLinariaPreval","wrap","fn","e","evalStage","cache","code","pluginOptions","filename","log","evaluated","linariaPreval","value","__linariaPreval","undefined","valueCache","Map","Object","entries","forEach","key","lazyValue","set","JSON","stringify","dependencies"],"sources":["../../src/transform-stages/2-eval.ts"],"sourcesContent":["import { createCustomDebug } from '@linaria/logger';\nimport type { ValueCache } from '@linaria/tags';\nimport type { StrictOptions } from '@linaria/utils';\nimport { getFileIdx } from '@linaria/utils';\n\nimport type { TransformCacheCollection } from '../cache';\nimport evaluate from '../evaluators';\nimport hasLinariaPreval from '../utils/hasLinariaPreval';\n\nconst wrap = <T>(fn: () => T): T | Error => {\n  try {\n    return fn();\n  } catch (e) {\n    return e as Error;\n  }\n};\n\n/**\n * Evaluates template dependencies.\n */\nexport default function evalStage(\n  cache: TransformCacheCollection,\n  code: string,\n  pluginOptions: StrictOptions,\n  filename: string\n): [ValueCache, string[]] | null {\n  const log = createCustomDebug('transform', getFileIdx(filename));\n\n  log('stage-2', `>> evaluate __linariaPreval`);\n\n  const evaluated = evaluate(cache, code, pluginOptions, filename);\n\n  const linariaPreval = hasLinariaPreval(evaluated.value)\n    ? evaluated.value.__linariaPreval\n    : undefined;\n\n  if (!linariaPreval) {\n    return null;\n  }\n\n  const valueCache: ValueCache = new Map();\n  Object.entries(linariaPreval).forEach(([key, lazyValue]) => {\n    const value = wrap(lazyValue);\n    valueCache.set(key, value);\n  });\n\n  log('stage-2', `<< evaluated __linariaPreval`, () =>\n    JSON.stringify(valueCache)\n  );\n\n  return [valueCache, evaluated.dependencies];\n}\n"],"mappings":"AAAA,SAASA,iBAAiB,QAAQ,iBAAiB;AAGnD,SAASC,UAAU,QAAQ,gBAAgB;AAG3C,OAAOC,QAAQ,MAAM,eAAe;AACpC,OAAOC,gBAAgB,MAAM,2BAA2B;AAExD,MAAMC,IAAI,GAAOC,EAAW,IAAgB;EAC1C,IAAI;IACF,OAAOA,EAAE,CAAC,CAAC;EACb,CAAC,CAAC,OAAOC,CAAC,EAAE;IACV,OAAOA,CAAC;EACV;AACF,CAAC;;AAED;AACA;AACA;AACA,eAAe,SAASC,SAASA,CAC/BC,KAA+B,EAC/BC,IAAY,EACZC,aAA4B,EAC5BC,QAAgB,EACe;EAC/B,MAAMC,GAAG,GAAGZ,iBAAiB,CAAC,WAAW,EAAEC,UAAU,CAACU,QAAQ,CAAC,CAAC;EAEhEC,GAAG,CAAC,SAAS,EAAG,6BAA4B,CAAC;EAE7C,MAAMC,SAAS,GAAGX,QAAQ,CAACM,KAAK,EAAEC,IAAI,EAAEC,aAAa,EAAEC,QAAQ,CAAC;EAEhE,MAAMG,aAAa,GAAGX,gBAAgB,CAACU,SAAS,CAACE,KAAK,CAAC,GACnDF,SAAS,CAACE,KAAK,CAACC,eAAe,GAC/BC,SAAS;EAEb,IAAI,CAACH,aAAa,EAAE;IAClB,OAAO,IAAI;EACb;EAEA,MAAMI,UAAsB,GAAG,IAAIC,GAAG,CAAC,CAAC;EACxCC,MAAM,CAACC,OAAO,CAACP,aAAa,CAAC,CAACQ,OAAO,CAAC,CAAC,CAACC,GAAG,EAAEC,SAAS,CAAC,KAAK;IAC1D,MAAMT,KAAK,GAAGX,IAAI,CAACoB,SAAS,CAAC;IAC7BN,UAAU,CAACO,GAAG,CAACF,GAAG,EAAER,KAAK,CAAC;EAC5B,CAAC,CAAC;EAEFH,GAAG,CAAC,SAAS,EAAG,8BAA6B,EAAE,MAC7Cc,IAAI,CAACC,SAAS,CAACT,UAAU,CAC3B,CAAC;EAED,OAAO,CAACA,UAAU,EAAEL,SAAS,CAACe,YAAY,CAAC;AAC7C"}