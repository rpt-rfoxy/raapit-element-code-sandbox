{"version":3,"file":"index.js","names":["hasEvaluatorMetadata","default","shakerPlugin","getKey","plugin","Array","isArray","key","hasKeyInList","list","pluginKey","some","i","includes","shaker","babelOptions","ast","code","highPriorityPlugins","config","babel","preShakePlugins","plugins","filter","require","resolve","hasCommonjsPlugin","push","transformOptions","caller","name","transformed","transformFromAstSync","metadata","Error","filename","linariaEvaluator","imports"],"sources":["../src/index.ts"],"sourcesContent":["import type { TransformOptions, PluginItem } from '@babel/core';\n\nimport type { Evaluator } from '@linaria/utils';\nimport { hasEvaluatorMetadata } from '@linaria/utils';\n\nexport { default as shakerPlugin } from './plugins/shaker-plugin';\n\nconst getKey = (plugin: PluginItem): string | null => {\n  if (typeof plugin === 'string') {\n    return plugin;\n  }\n\n  if (Array.isArray(plugin)) {\n    return getKey(plugin[0]);\n  }\n\n  if (typeof plugin === 'object' && plugin !== null && 'key' in plugin) {\n    return (plugin as { key?: string | null }).key ?? null;\n  }\n\n  return null;\n};\n\nconst hasKeyInList = (plugin: PluginItem, list: string[]): boolean => {\n  const pluginKey = getKey(plugin);\n  return pluginKey ? list.some((i) => pluginKey.includes(i)) : false;\n};\n\nconst shaker: Evaluator = (\n  babelOptions,\n  ast,\n  code,\n  { highPriorityPlugins, ...config },\n  babel\n) => {\n  const preShakePlugins =\n    babelOptions.plugins?.filter((i) => hasKeyInList(i, highPriorityPlugins)) ??\n    [];\n\n  const plugins = [\n    ...preShakePlugins,\n    [require.resolve('./plugins/shaker-plugin'), config],\n    ...(babelOptions.plugins ?? []).filter(\n      (i) => !hasKeyInList(i, highPriorityPlugins)\n    ),\n  ];\n\n  const hasCommonjsPlugin = babelOptions.plugins?.some(\n    (i) => getKey(i) === 'transform-modules-commonjs'\n  );\n\n  if (!hasCommonjsPlugin) {\n    plugins.push(require.resolve('@babel/plugin-transform-modules-commonjs'));\n  }\n\n  const transformOptions: TransformOptions = {\n    ...babelOptions,\n    caller: {\n      name: 'linaria',\n    },\n    plugins,\n  };\n\n  const transformed = babel.transformFromAstSync(ast, code, transformOptions);\n\n  if (!transformed || !hasEvaluatorMetadata(transformed.metadata)) {\n    throw new Error(`${babelOptions.filename} has no shaker metadata`);\n  }\n\n  return [\n    transformed.ast!,\n    transformed.code ?? '',\n    transformed.metadata.linariaEvaluator.imports,\n  ];\n};\n\nexport default shaker;\n"],"mappings":"AAGA,SAASA,oBAAoB,QAAQ,gBAAgB;AAErD,SAASC,OAAO,IAAIC,YAAY,QAAQ,yBAAyB;AAEjE,MAAMC,MAAM,GAAIC,MAAkB,IAAoB;EACpD,IAAI,OAAOA,MAAM,KAAK,QAAQ,EAAE;IAC9B,OAAOA,MAAM;EACf;EAEA,IAAIC,KAAK,CAACC,OAAO,CAACF,MAAM,CAAC,EAAE;IACzB,OAAOD,MAAM,CAACC,MAAM,CAAC,CAAC,CAAC,CAAC;EAC1B;EAEA,IAAI,OAAOA,MAAM,KAAK,QAAQ,IAAIA,MAAM,KAAK,IAAI,IAAI,KAAK,IAAIA,MAAM,EAAE;IACpE,OAAQA,MAAM,CAA6BG,GAAG,IAAI,IAAI;EACxD;EAEA,OAAO,IAAI;AACb,CAAC;AAED,MAAMC,YAAY,GAAGA,CAACJ,MAAkB,EAAEK,IAAc,KAAc;EACpE,MAAMC,SAAS,GAAGP,MAAM,CAACC,MAAM,CAAC;EAChC,OAAOM,SAAS,GAAGD,IAAI,CAACE,IAAI,CAAEC,CAAC,IAAKF,SAAS,CAACG,QAAQ,CAACD,CAAC,CAAC,CAAC,GAAG,KAAK;AACpE,CAAC;AAED,MAAME,MAAiB,GAAGA,CACxBC,YAAY,EACZC,GAAG,EACHC,IAAI,EACJ;EAAEC,mBAAmB;EAAE,GAAGC;AAAO,CAAC,EAClCC,KAAK,KACF;EACH,MAAMC,eAAe,GACnBN,YAAY,CAACO,OAAO,EAAEC,MAAM,CAAEX,CAAC,IAAKJ,YAAY,CAACI,CAAC,EAAEM,mBAAmB,CAAC,CAAC,IACzE,EAAE;EAEJ,MAAMI,OAAO,GAAG,CACd,GAAGD,eAAe,EAClB,CAACG,OAAO,CAACC,OAAO,CAAC,yBAAyB,CAAC,EAAEN,MAAM,CAAC,EACpD,GAAG,CAACJ,YAAY,CAACO,OAAO,IAAI,EAAE,EAAEC,MAAM,CACnCX,CAAC,IAAK,CAACJ,YAAY,CAACI,CAAC,EAAEM,mBAAmB,CAC7C,CAAC,CACF;EAED,MAAMQ,iBAAiB,GAAGX,YAAY,CAACO,OAAO,EAAEX,IAAI,CACjDC,CAAC,IAAKT,MAAM,CAACS,CAAC,CAAC,KAAK,4BACvB,CAAC;EAED,IAAI,CAACc,iBAAiB,EAAE;IACtBJ,OAAO,CAACK,IAAI,CAACH,OAAO,CAACC,OAAO,CAAC,0CAA0C,CAAC,CAAC;EAC3E;EAEA,MAAMG,gBAAkC,GAAG;IACzC,GAAGb,YAAY;IACfc,MAAM,EAAE;MACNC,IAAI,EAAE;IACR,CAAC;IACDR;EACF,CAAC;EAED,MAAMS,WAAW,GAAGX,KAAK,CAACY,oBAAoB,CAAChB,GAAG,EAAEC,IAAI,EAAEW,gBAAgB,CAAC;EAE3E,IAAI,CAACG,WAAW,IAAI,CAAC/B,oBAAoB,CAAC+B,WAAW,CAACE,QAAQ,CAAC,EAAE;IAC/D,MAAM,IAAIC,KAAK,CAAE,GAAEnB,YAAY,CAACoB,QAAS,yBAAwB,CAAC;EACpE;EAEA,OAAO,CACLJ,WAAW,CAACf,GAAG,EACfe,WAAW,CAACd,IAAI,IAAI,EAAE,EACtBc,WAAW,CAACE,QAAQ,CAACG,gBAAgB,CAACC,OAAO,CAC9C;AACH,CAAC;AAED,eAAevB,MAAM"}