{"version":3,"file":"index.js","names":["_utils","require","_shakerPlugin","_interopRequireDefault","obj","__esModule","default","getKey","plugin","Array","isArray","_key","key","hasKeyInList","list","pluginKey","some","i","includes","shaker","babelOptions","ast","code","highPriorityPlugins","config","babel","_babelOptions$plugins","_babelOptions$plugins2","_babelOptions$plugins3","_babelOptions$plugins4","_transformed$code","preShakePlugins","plugins","filter","resolve","hasCommonjsPlugin","push","transformOptions","caller","name","transformed","transformFromAstSync","hasEvaluatorMetadata","metadata","Error","filename","linariaEvaluator","imports","_default","exports"],"sources":["../src/index.ts"],"sourcesContent":["import type { TransformOptions, PluginItem } from '@babel/core';\n\nimport type { Evaluator } from '@linaria/utils';\nimport { hasEvaluatorMetadata } from '@linaria/utils';\n\nexport { default as shakerPlugin } from './plugins/shaker-plugin';\n\nconst getKey = (plugin: PluginItem): string | null => {\n  if (typeof plugin === 'string') {\n    return plugin;\n  }\n\n  if (Array.isArray(plugin)) {\n    return getKey(plugin[0]);\n  }\n\n  if (typeof plugin === 'object' && plugin !== null && 'key' in plugin) {\n    return (plugin as { key?: string | null }).key ?? null;\n  }\n\n  return null;\n};\n\nconst hasKeyInList = (plugin: PluginItem, list: string[]): boolean => {\n  const pluginKey = getKey(plugin);\n  return pluginKey ? list.some((i) => pluginKey.includes(i)) : false;\n};\n\nconst shaker: Evaluator = (\n  babelOptions,\n  ast,\n  code,\n  { highPriorityPlugins, ...config },\n  babel\n) => {\n  const preShakePlugins =\n    babelOptions.plugins?.filter((i) => hasKeyInList(i, highPriorityPlugins)) ??\n    [];\n\n  const plugins = [\n    ...preShakePlugins,\n    [require.resolve('./plugins/shaker-plugin'), config],\n    ...(babelOptions.plugins ?? []).filter(\n      (i) => !hasKeyInList(i, highPriorityPlugins)\n    ),\n  ];\n\n  const hasCommonjsPlugin = babelOptions.plugins?.some(\n    (i) => getKey(i) === 'transform-modules-commonjs'\n  );\n\n  if (!hasCommonjsPlugin) {\n    plugins.push(require.resolve('@babel/plugin-transform-modules-commonjs'));\n  }\n\n  const transformOptions: TransformOptions = {\n    ...babelOptions,\n    caller: {\n      name: 'linaria',\n    },\n    plugins,\n  };\n\n  const transformed = babel.transformFromAstSync(ast, code, transformOptions);\n\n  if (!transformed || !hasEvaluatorMetadata(transformed.metadata)) {\n    throw new Error(`${babelOptions.filename} has no shaker metadata`);\n  }\n\n  return [\n    transformed.ast!,\n    transformed.code ?? '',\n    transformed.metadata.linariaEvaluator.imports,\n  ];\n};\n\nexport default shaker;\n"],"mappings":";;;;;;;;;;;;AAGA,IAAAA,MAAA,GAAAC,OAAA;AAEA,IAAAC,aAAA,GAAAC,sBAAA,CAAAF,OAAA;AAAkE,SAAAE,uBAAAC,GAAA,WAAAA,GAAA,IAAAA,GAAA,CAAAC,UAAA,GAAAD,GAAA,KAAAE,OAAA,EAAAF,GAAA;AAElE,MAAMG,MAAM,GAAIC,MAAkB,IAAoB;EACpD,IAAI,OAAOA,MAAM,KAAK,QAAQ,EAAE;IAC9B,OAAOA,MAAM;EACf;EAEA,IAAIC,KAAK,CAACC,OAAO,CAACF,MAAM,CAAC,EAAE;IACzB,OAAOD,MAAM,CAACC,MAAM,CAAC,CAAC,CAAC,CAAC;EAC1B;EAEA,IAAI,OAAOA,MAAM,KAAK,QAAQ,IAAIA,MAAM,KAAK,IAAI,IAAI,KAAK,IAAIA,MAAM,EAAE;IAAA,IAAAG,IAAA;IACpE,QAAAA,IAAA,GAAQH,MAAM,CAA6BI,GAAG,cAAAD,IAAA,cAAAA,IAAA,GAAI,IAAI;EACxD;EAEA,OAAO,IAAI;AACb,CAAC;AAED,MAAME,YAAY,GAAGA,CAACL,MAAkB,EAAEM,IAAc,KAAc;EACpE,MAAMC,SAAS,GAAGR,MAAM,CAACC,MAAM,CAAC;EAChC,OAAOO,SAAS,GAAGD,IAAI,CAACE,IAAI,CAAEC,CAAC,IAAKF,SAAS,CAACG,QAAQ,CAACD,CAAC,CAAC,CAAC,GAAG,KAAK;AACpE,CAAC;AAED,MAAME,MAAiB,GAAGA,CACxBC,YAAY,EACZC,GAAG,EACHC,IAAI,EACJ;EAAEC,mBAAmB;EAAE,GAAGC;AAAO,CAAC,EAClCC,KAAK,KACF;EAAA,IAAAC,qBAAA,EAAAC,sBAAA,EAAAC,sBAAA,EAAAC,sBAAA,EAAAC,iBAAA;EACH,MAAMC,eAAe,IAAAL,qBAAA,IAAAC,sBAAA,GACnBP,YAAY,CAACY,OAAO,cAAAL,sBAAA,uBAApBA,sBAAA,CAAsBM,MAAM,CAAEhB,CAAC,IAAKJ,YAAY,CAACI,CAAC,EAAEM,mBAAmB,CAAC,CAAC,cAAAG,qBAAA,cAAAA,qBAAA,GACzE,EAAE;EAEJ,MAAMM,OAAO,GAAG,CACd,GAAGD,eAAe,EAClB,CAAC9B,OAAO,CAACiC,OAAO,CAAC,yBAAyB,CAAC,EAAEV,MAAM,CAAC,EACpD,GAAG,EAAAI,sBAAA,GAACR,YAAY,CAACY,OAAO,cAAAJ,sBAAA,cAAAA,sBAAA,GAAI,EAAE,EAAEK,MAAM,CACnChB,CAAC,IAAK,CAACJ,YAAY,CAACI,CAAC,EAAEM,mBAAmB,CAC7C,CAAC,CACF;EAED,MAAMY,iBAAiB,IAAAN,sBAAA,GAAGT,YAAY,CAACY,OAAO,cAAAH,sBAAA,uBAApBA,sBAAA,CAAsBb,IAAI,CACjDC,CAAC,IAAKV,MAAM,CAACU,CAAC,CAAC,KAAK,4BACvB,CAAC;EAED,IAAI,CAACkB,iBAAiB,EAAE;IACtBH,OAAO,CAACI,IAAI,CAACnC,OAAO,CAACiC,OAAO,CAAC,0CAA0C,CAAC,CAAC;EAC3E;EAEA,MAAMG,gBAAkC,GAAG;IACzC,GAAGjB,YAAY;IACfkB,MAAM,EAAE;MACNC,IAAI,EAAE;IACR,CAAC;IACDP;EACF,CAAC;EAED,MAAMQ,WAAW,GAAGf,KAAK,CAACgB,oBAAoB,CAACpB,GAAG,EAAEC,IAAI,EAAEe,gBAAgB,CAAC;EAE3E,IAAI,CAACG,WAAW,IAAI,CAAC,IAAAE,2BAAoB,EAACF,WAAW,CAACG,QAAQ,CAAC,EAAE;IAC/D,MAAM,IAAIC,KAAK,CAAE,GAAExB,YAAY,CAACyB,QAAS,yBAAwB,CAAC;EACpE;EAEA,OAAO,CACLL,WAAW,CAACnB,GAAG,GAAAS,iBAAA,GACfU,WAAW,CAAClB,IAAI,cAAAQ,iBAAA,cAAAA,iBAAA,GAAI,EAAE,EACtBU,WAAW,CAACG,QAAQ,CAACG,gBAAgB,CAACC,OAAO,CAC9C;AACH,CAAC;AAAC,IAAAC,QAAA,GAEa7B,MAAM;AAAA8B,OAAA,CAAA3C,OAAA,GAAA0C,QAAA"}